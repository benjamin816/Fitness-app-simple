<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ben’s Lift + Daily Goals Tracker</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 25px rgba(17,24,39,.08);
      --radius:16px;
      --accent:#111827;
      --danger:#b91c1c;
      --warn:#b45309;
      --warnBg:#fffbeb;
      --ok:#166534;
      --okBg:#dcfce7;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:22px auto 80px;padding:0 16px;}
    header{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap}
    h1{margin:0;font-size:20px;letter-spacing:.2px;}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px;}
    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;}
    @media (max-width:860px){.row{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 10px;font-size:15px;}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
    input[type="number"], select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      background:#fff;
      color:var(--text);
    }
    input:focus, select:focus{border-color:#cbd5e1}
    .inline{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:520px){.inline{grid-template-columns:1fr}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    button{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
    button.danger{border-color:#fecaca;color:var(--danger);}
    button.icon{padding:10px 11px; font-weight:900}
    button:disabled{opacity:.45; cursor:not-allowed}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);background:#fff;
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:520px){.twoCol{grid-template-columns:1fr}}
    .checkRow{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;border:1px solid var(--line);border-radius:14px;
    }
    .checkRow strong{font-size:13px}
    .checkRow .right{display:flex;gap:10px;align-items:center}
    .small{font-size:12px;color:var(--muted)}

    /* Switch */
    .switchLabel{display:inline-flex;align-items:center;cursor:pointer;user-select:none}
    .switchLabel input{position:absolute;opacity:0;pointer-events:none}
    .slider{
      width:46px;height:28px;border-radius:999px;
      background:#e5e7eb;border:1px solid var(--line);
      position:relative;flex:0 0 auto;
      transition: background .15s ease, border-color .15s ease;
    }
    .slider::after{
      content:"";position:absolute;top:3px;left:3px;
      width:22px;height:22px;border-radius:50%;
      background:#fff;border:1px solid var(--line);
      transition:left .15s ease, border-color .15s ease;
    }
    .switchLabel input:checked + .slider{background:var(--okBg);border-color:#86efac;}
    .switchLabel input:checked + .slider::after{left:21px;border-color:#86efac;}

    /* 1-10 picker */
    .scaleRow{display:flex;gap:6px;flex-wrap:wrap}
    .scaleBtn{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--line);background:#fff;
      font-weight:900;cursor:pointer;
    }
    .scaleBtn.on{background:#111827;color:#fff;border-color:#111827}
    .scaleHint{margin-top:6px}

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(17,24,39,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:min(980px, 100%);
      max-height: 86vh;
      overflow:auto;
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modalHeader{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .modalHeader h3{margin:0;font-size:15px}
    .modalHeader .meta{margin-top:4px;color:var(--muted);font-size:12px}

    .historyList{display:flex;flex-direction:column;gap:10px;max-height:520px;overflow:auto;padding-right:6px;}
    .histItem{
      border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;
      display:flex;gap:10px;justify-content:space-between;align-items:flex-start;
    }
    .histItem .left{min-width:0}
    .histItem .date{font-weight:950;font-size:13px}
    .histItem .meta{margin-top:4px;color:var(--muted);font-size:12px}
    .histItem .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .badge{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;color:#374151;white-space:nowrap;}
    .badge.good{border-color:#86efac;background:var(--okBg); color:var(--ok);}
    .badge.warn{border-color:#fbbf24;background:var(--warnBg); color:var(--warn);}
    .avgBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      margin-bottom:12px;
    }
    .avgTitle{font-weight:950;font-size:13px}
    .avgMeta{margin-top:4px;color:var(--muted);font-size:12px}

    .nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .dateLabel{font-weight:950;color:#111827}

    /* Plan cards */
    .planCard{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      margin:12px 0;
      background:#fff;
    }
    .planName{font-weight:950;font-size:14px}
    .planSub{margin-top:4px;color:var(--muted);font-size:12px}
    .planMetaLines{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}
    .planInputRow{margin-top:10px}
    .miniChecks{display:flex;gap:14px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .miniChecks label{margin:0;color:var(--muted);font-size:12px;display:flex;gap:8px;align-items:center}
    .miniChecks input{width:auto}
    .flagRow{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:10px}
    .flagRow .left{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .flagRow .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Lift + Daily Goals Tracker</h1>
        <div class="sub">Auto-saves every change. Local time. No accounts. v7 adds stall + upgrade suggestions.</div>
      </div>

      <div class="nav">
        <button id="prevDayBtn" type="button">← Prev</button>
        <span class="pill"><span class="dateLabel" id="dateLabel">—</span></span>
        <button id="nextDayBtn" type="button">Next →</button>
        <button id="todayBtn" type="button">Today</button>
        <button id="settingsBtn" class="icon" type="button" title="Settings">⚙︎</button>
      </div>
    </header>

    <div class="row">
      <div class="card">
        <h2>Daily</h2>

        <div class="inline">
          <div>
            <label>Body weight (lb)</label>
            <input id="bw" type="number" step="0.1" placeholder="e.g. 159.0" />
          </div>
          <div>
            <label>Workout</label>
            <select id="workoutSelect">
              <option value="">None</option>
              <option value="A">Workout A</option>
              <option value="B">Workout B</option>
            </select>
          </div>
        </div>

        <div class="small muted" id="workoutDesc" style="margin-top:8px">Pick a workout to see what it is.</div>
        <div class="btns" style="margin-top:10px">
          <button id="openPlanBtn" class="primary" type="button" disabled style="display:none">Open & Track Plan</button>
        </div>

        <div class="hr"></div>

        <h2>Daily goals</h2>

        <div class="twoCol">
          <div class="checkRow">
            <div>
              <strong>Steps</strong>
              <div class="small" id="stepsGoalText">Goal: —</div>
            </div>
            <div class="right">
              <input id="steps" type="number" inputmode="numeric" style="width:140px" placeholder="0" />
              <label class="switchLabel" title="Met steps goal">
                <input id="stepsChk" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="checkRow">
            <div>
              <strong>Calories</strong>
              <div class="small" id="calsGoalText">Limit: —</div>
            </div>
            <div class="right">
              <input id="cals" type="number" inputmode="numeric" style="width:140px" placeholder="0" />
              <label class="switchLabel" title="Under calorie limit">
                <input id="calsChk" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="checkRow">
            <div>
              <strong>Protein</strong>
              <div class="small" id="proteinGoalText">Goal: —</div>
            </div>
            <div class="right">
              <input id="protein" type="number" inputmode="numeric" style="width:140px" placeholder="0" />
              <label class="switchLabel" title="Hit protein goal">
                <input id="proteinChk" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="checkRow">
            <div>
              <strong>Pickleball / Activity</strong>
              <div class="small">Did any intentional activity?</div>
            </div>
            <div class="right">
              <label class="switchLabel" title="Did pickleball or another activity">
                <input id="activityChk" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Check-in</h2>
        <div class="twoCol">
          <div>
            <label>Stress (1–10)</label>
            <div class="scaleRow" id="stressRow"></div>
            <div class="small muted scaleHint" id="stressHint">Not set</div>
          </div>
          <div>
            <label>Energy (1–10)</label>
            <div class="scaleRow" id="energyRow"></div>
            <div class="small muted scaleHint" id="energyHint">Not set</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="btns">
          <button id="copyBtn" type="button">Copy backup</button>
          <button id="resetBtn" class="danger" type="button">Reset day</button>
        </div>
      </div>

      <div class="card">
        <h2>History (latest first)</h2>
        <div class="small muted" style="margin-bottom:10px">Tap “Load” to bring a day back.</div>

        <div class="avgBox" id="avgBox" style="display:none">
          <div class="avgTitle" id="avgTitle">7‑weigh‑in average: —</div>
          <div class="avgMeta">Uses 7 weigh-ins inside a 10‑day window ending on the day you’re viewing.</div>
        </div>

        <div class="historyList" id="historyList"></div>
      </div>
    </div>
  </div>

  <!-- Plan Modal -->
  <div class="modalBackdrop" id="planBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div>
          <h3 id="planTitle">Workout Plan</h3>
          <div class="meta" id="planMeta">—</div>
        </div>
        <div class="btns" style="margin-top:0">
          <button id="closePlanBtn" type="button">Close</button>
        </div>
      </div>

      <div class="small muted" style="margin-bottom:8px">
        “Today’s Goal” is auto-filled (edit it if needed). Stall/upgrade flags are conservative on purpose.
      </div>

      <div id="planRows"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modalBackdrop" id="settingsBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div>
          <h3>Settings</h3>
          <div class="meta">Goals + rep targets + progression. Saved automatically.</div>
        </div>
        <div class="btns" style="margin-top:0">
          <button id="closeSettingsBtn" type="button">Close</button>
        </div>
      </div>

      <div class="twoCol">
        <div>
          <label>Steps goal</label>
          <input id="setStepsGoal" type="number" inputmode="numeric" />
        </div>
        <div>
          <label>Calorie limit</label>
          <input id="setCalsGoal" type="number" inputmode="numeric" />
        </div>
      </div>

      <div class="twoCol" style="margin-top:12px">
        <div>
          <label>Protein goal (g)</label>
          <input id="setProteinGoal" type="number" inputmode="numeric" />
        </div>
        <div>
          <label>Weight increment (lb)</label>
          <input id="setIncrement" type="number" step="0.5" inputmode="decimal" />
          <div class="small muted" style="margin-top:6px">Default +5. Stall response step 1 is to cut this to +2.5 for that lift.</div>
        </div>
      </div>

      <div class="hr"></div>
      <h2 style="margin:0 0 10px;font-size:15px;">Rep targets</h2>
      <div class="small muted" style="margin-bottom:10px">Plan assumes these reps (change anytime).</div>
      <div id="repSettings"></div>

      <div class="hr"></div>
      <h2 style="margin:0 0 10px;font-size:15px;">Progression rules</h2>
      <div class="small muted">
        Weighted lifts flag “stall” only if: <strong>5 exposures in 30 days</strong>, no load increase, and <strong>≥2 failures</strong>.<br>
        Core upgrades flag only if: plank ≥ <strong>90s</strong> (3 hits) or leg raises ≥ <strong>18 reps</strong> (3 hits).<br>
        Approving a swap permanently changes the template until the next approved change.
      </div>

      <div class="hr"></div>
      <button id="resetSettingsBtn" class="danger" type="button">Reset settings to defaults</button>
    </div>
  </div>

<script>
(() => {
  // ===== Variation pools (rotation-based, manual approve, persistent) =====
  // Each "slot" in Workout A/B points to a pool. The pool has variants with unique keys.
  const POOLS = {
    bench: [
      { key:"bench_bb", name:"Barbell Bench Press", guide:"Steady reps, full range", type:"weight" },
      { key:"bench_db", name:"Dumbbell Bench Press", guide:"Control down; neutral wrists", type:"weight" },
      { key:"bench_pause", name:"Pause Bench Press", guide:"1s pause on chest", type:"weight" },
      { key:"bench_incline_db", name:"Incline Dumbbell Bench", guide:"Upper chest focus", type:"weight" }
    ],
    row: [
      { key:"row_1arm_db", name:"One‑arm Dumbbell Row", guide:"Each side; pull elbow to hip", type:"weight" },
      { key:"row_bb", name:"Barbell Row", guide:"Hinge; don’t jerk", type:"weight" },
      { key:"row_chest", name:"Chest‑Supported Row (DB)", guide:"Bench incline supported", type:"weight" }
    ],
    press: [
      { key:"press_db", name:"Dumbbell Shoulder Press", guide:"Control down", type:"weight" },
      { key:"press_seated_db", name:"Seated DB Press", guide:"Less leg drive", type:"weight" },
      { key:"press_arnold", name:"Arnold Press", guide:"Rotate under control", type:"weight" }
    ],
    curl: [
      { key:"curl_bb", name:"Barbell or DB Curl", guide:"No swinging", type:"weight" },
      { key:"curl_incline_db", name:"Incline DB Curl", guide:"Big stretch", type:"weight" }
    ],
    squat: [
      { key:"squat_bb", name:"Barbell Squat", guide:"Brace hard", type:"weight" },
      { key:"squat_front", name:"Front Squat", guide:"Upright torso", type:"weight" },
      { key:"squat_pause", name:"Pause Squat", guide:"1s pause at depth", type:"weight" }
    ],
    hinge: [
      { key:"rdl_bb", name:"Romanian Deadlift", guide:"Hamstrings; flat back", type:"weight" },
      { key:"hip_thrust", name:"Hip Thrust (barbell)", guide:"Full lockout", type:"weight" },
      { key:"rdl_1leg", name:"Single‑Leg RDL (DB)", guide:"Balance + hamstring", type:"weight" }
    ],
    push: [
      { key:"pushup", name:"Pushups (slow + controlled)", guide:"Full range", type:"weight" },
      { key:"pushup_elev", name:"Feet‑Elevated Pushups", guide:"Harder angle", type:"weight" },
      { key:"pushup_weighted", name:"Weighted Pushups", guide:"Backpack/plate", type:"weight" }
    ],
    hammer: [
      { key:"hammer", name:"Hammer Curls", guide:"Neutral grip", type:"weight" },
      { key:"hammer_cross", name:"Cross‑Body Hammer Curl", guide:"Across torso", type:"weight" },
      { key:"curl_reverse", name:"Reverse Curl", guide:"Forearm + brachialis", type:"weight" }
    ],
    plank: [
      { key:"plank_std", name:"Plank", guide:"Time to near‑failure", type:"time" },
      { key:"plank_long", name:"Long‑Lever Plank", guide:"Harder lever", type:"time" },
      { key:"plank_weighted", name:"Weighted Plank", guide:"Plate/backpack", type:"time" }
    ],
    legraise: [
      { key:"legraise", name:"Leg Raises (lying)", guide:"Controlled reps", type:"reps" },
      { key:"hang_knee", name:"Hanging Knee Raises", guide:"Control; no swing", type:"reps" },
      { key:"hang_leg", name:"Hanging Leg Raises", guide:"Harder; no swing", type:"reps" }
    ]
  };

  // Workout templates reference pool + reps defaults + sets
  const TEMPLATE = {
    A: [
      { pool:"bench", sets:3, repsDefault:9 },
      { pool:"row", sets:3, repsDefault:10, perSide:true },
      { pool:"press", sets:3, repsDefault:9 },
      { pool:"curl", sets:3, repsDefault:11 },
      { pool:"plank", sets:3, repsDefault:1 } // time-based
    ],
    B: [
      { pool:"squat", sets:3, repsDefault:9 },
      { pool:"hinge", sets:3, repsDefault:9 },
      { pool:"push", sets:3, repsDefault:12 },
      { pool:"hammer", sets:3, repsDefault:11 },
      { pool:"legraise", sets:3, repsDefault:13 }
    ]
  };

  // ===== Settings + store =====
  const DEFAULT_SETTINGS = {
    goals: { steps: 10000, calories: 1800, protein: 130 },
    increment: 5,
    reps: {},                  // per variant key
    activeVariantIndex: {       // per pool
      bench:0,row:0,press:0,curl:0,
      squat:0,hinge:0,push:0,hammer:0,
      plank:0,legraise:0
    },
    // per pool microload flag (if stalled once)
    microload: {
      bench:false,row:false,press:false,curl:false,
      squat:false,hinge:false,push:false,hammer:false,
      plank:false,legraise:false
    },
    // thresholds for core upgrades
    plankUpgradeSec: 90,
    legRaiseUpgradeReps: 18,
  };

  // Build default reps for every variant
  function buildDefaultReps(){
    const reps = {};
    Object.keys(TEMPLATE).forEach(w=>{
      TEMPLATE[w].forEach(slot=>{
        const pool = slot.pool;
        POOLS[pool].forEach(v=>{
          // Use slot repsDefault for all variants in that pool by default
          if(!(v.key in reps)) reps[v.key] = slot.repsDefault;
        });
      });
    });
    return reps;
  }
  DEFAULT_SETTINGS.reps = buildDefaultReps();

  const STORE_KEY = "ben_lift_daily_tracker_v7_store";
  const SETTINGS_KEY = "ben_lift_daily_tracker_v7_settings";

  const el = (id)=>document.getElementById(id);

  function loadJSON(key, fallback){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
    catch(e){ return fallback; }
  }
  function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  let store = loadJSON(STORE_KEY, { days: {} });
  let settings = loadJSON(SETTINGS_KEY, DEFAULT_SETTINGS);

  // normalize settings
  if(!settings || typeof settings !== "object") settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
  if(!settings.goals) settings.goals = JSON.parse(JSON.stringify(DEFAULT_SETTINGS.goals));
  if(!settings.reps) settings.reps = buildDefaultReps();
  if(!settings.activeVariantIndex) settings.activeVariantIndex = JSON.parse(JSON.stringify(DEFAULT_SETTINGS.activeVariantIndex));
  if(!settings.microload) settings.microload = JSON.parse(JSON.stringify(DEFAULT_SETTINGS.microload));
  if(!settings.increment) settings.increment = DEFAULT_SETTINGS.increment;

  // ===== Migration from older versions (bench -> bench_bb, etc.) =====
  function migrateLegacyLogs(){
    const renameMap = {
      bench:"bench_bb",
      db_row:"row_1arm_db",
      db_press:"press_db",
      curl:"curl_bb",
      squat:"squat_bb",
      rdl:"rdl_bb",
      pushup:"pushup",
      hammer:"hammer",
      plank:"plank_std",
      leg_raise:"legraise"
    };
    let changed = false;
    for(const d of Object.keys(store.days||{})){
      const wl = store.days[d]?.workoutLog;
      if(!wl) continue;
      for(const oldKey of Object.keys(renameMap)){
        if(wl[oldKey] && !wl[renameMap[oldKey]]){
          wl[renameMap[oldKey]] = wl[oldKey];
          delete wl[oldKey];
          changed = true;
        }
      }
    }
    if(changed) saveJSON(STORE_KEY, store);
  }
  migrateLegacyLogs();

  // ===== Date helpers =====
  function isoLocalDate(d){
    const tzOffset = d.getTimezoneOffset();
    const local = new Date(d.getTime() - tzOffset*60000);
    return local.toISOString().slice(0,10);
  }
  function todayISO(){ return isoLocalDate(new Date()); }
  function addDaysISO(iso, delta){
    const [y,m,dd] = iso.split("-").map(Number);
    const d = new Date(y, m-1, dd);
    d.setDate(d.getDate() + delta);
    return isoLocalDate(d);
  }
  function prettyDate(iso){
    const [y,m,d] = iso.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"short", day:"numeric" });
  }
  function sortedDatesDesc(){ return Object.keys(store.days).sort((a,b)=> b.localeCompare(a)); }

  // ===== UI refs =====
  const dateLabel = el("dateLabel");
  const prevDayBtn = el("prevDayBtn");
  const nextDayBtn = el("nextDayBtn");
  const todayBtn = el("todayBtn");
  const settingsBtn = el("settingsBtn");

  const bw = el("bw");
  const workoutSelect = el("workoutSelect");
  const workoutDesc = el("workoutDesc");
  const openPlanBtn = el("openPlanBtn");

  const stepsGoalText = el("stepsGoalText");
  const calsGoalText = el("calsGoalText");
  const proteinGoalText = el("proteinGoalText");

  const steps = el("steps");
  const cals = el("cals");
  const protein = el("protein");
  const stepsChk = el("stepsChk");
  const calsChk = el("calsChk");
  const proteinChk = el("proteinChk");
  const activityChk = el("activityChk");

  const stressRow = el("stressRow");
  const energyRow = el("energyRow");
  const stressHint = el("stressHint");
  const energyHint = el("energyHint");

  const copyBtn = el("copyBtn");
  const resetBtn = el("resetBtn");
  const historyList = el("historyList");

  const avgBox = el("avgBox");
  const avgTitle = el("avgTitle");

  // plan modal
  const planBackdrop = el("planBackdrop");
  const planTitle = el("planTitle");
  const planMeta = el("planMeta");
  const planRows = el("planRows");
  const closePlanBtn = el("closePlanBtn");

  // settings modal
  const settingsBackdrop = el("settingsBackdrop");
  const closeSettingsBtn = el("closeSettingsBtn");
  const setStepsGoal = el("setStepsGoal");
  const setCalsGoal = el("setCalsGoal");
  const setProteinGoal = el("setProteinGoal");
  const setIncrement = el("setIncrement");
  const repSettings = el("repSettings");
  const resetSettingsBtn = el("resetSettingsBtn");

  // state
  let selectedDate = todayISO();
  let stressVal = null;
  let energyVal = null;

  // autosave
  let saveTimer = null;
  function queueAutoSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(autoSaveNow, 160);
  }
  function autoSaveNow(){
    store.days[selectedDate] = collectEditorData();
    saveJSON(STORE_KEY, store);
    renderHistory();
    renderWeightAverage();
  }

  function refreshGoalTexts(){
    stepsGoalText.textContent = `Goal: ${settings.goals.steps.toLocaleString()}`;
    calsGoalText.textContent = `Limit: ${settings.goals.calories.toLocaleString()}`;
    proteinGoalText.textContent = `Goal: ${settings.goals.protein}g`;
  }

  function workoutDescription(which){
    if(which === "A") return "Workout A = press + row + shoulders + biceps + plank.";
    if(which === "B") return "Workout B = squat + hinge + pushups + biceps + leg raises.";
    return "Pick a workout to see what it is.";
  }
  function updateOpenPlanVisibility(){
    const ok = (workoutSelect.value === "A" || workoutSelect.value === "B");
    openPlanBtn.style.display = ok ? "inline-block" : "none";
    openPlanBtn.disabled = !ok;
  }

  function syncChecksFromInputs(){
    const s = Number(steps.value || 0);
    stepsChk.checked = s >= settings.goals.steps;

    const cal = Number(cals.value || 0);
    calsChk.checked = cal > 0 ? cal <= settings.goals.calories : false;

    const p = Number(protein.value || 0);
    proteinChk.checked = p >= settings.goals.protein;
  }

  // toggles
  stepsChk.addEventListener("change", ()=>{
    steps.value = stepsChk.checked ? String(settings.goals.steps) : "";
    syncChecksFromInputs(); queueAutoSave();
  });
  calsChk.addEventListener("change", ()=>{
    cals.value = calsChk.checked ? String(settings.goals.calories) : "";
    syncChecksFromInputs(); queueAutoSave();
  });
  proteinChk.addEventListener("change", ()=>{
    protein.value = proteinChk.checked ? String(settings.goals.protein) : "";
    syncChecksFromInputs(); queueAutoSave();
  });
  activityChk.addEventListener("change", queueAutoSave);

  [steps,cals,protein,bw].forEach(inp=>{
    inp.addEventListener("input", ()=>{ syncChecksFromInputs(); queueAutoSave(); });
  });

  // scales
  function buildScale(rowEl, hintEl, setter){
    rowEl.innerHTML = "";
    for(let i=1;i<=10;i++){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "scaleBtn";
      b.textContent = String(i);
      b.dataset.val = String(i);
      b.addEventListener("click", ()=>{
        rowEl.querySelectorAll(".scaleBtn").forEach(x=>x.classList.remove("on"));
        b.classList.add("on");
        hintEl.textContent = `Selected: ${i}`;
        setter(i);
        queueAutoSave();
      });
      rowEl.appendChild(b);
    }
  }
  function setScaleValue(rowEl, hintEl, val){
    rowEl.querySelectorAll(".scaleBtn").forEach(x=>{
      x.classList.toggle("on", Number(x.dataset.val) === Number(val));
    });
    hintEl.textContent = val ? `Selected: ${val}` : "Not set";
  }
  buildScale(stressRow, stressHint, (v)=>{ stressVal = v; });
  buildScale(energyRow, energyHint, (v)=>{ energyVal = v; });

  // modals
  function openModal(backdrop){ backdrop.classList.add("show"); backdrop.setAttribute("aria-hidden","false"); }
  function closeModal(backdrop){ backdrop.classList.remove("show"); backdrop.setAttribute("aria-hidden","true"); }
  closePlanBtn.addEventListener("click", ()=>closeModal(planBackdrop));
  planBackdrop.addEventListener("click", (e)=>{ if(e.target === planBackdrop) closeModal(planBackdrop); });
  closeSettingsBtn.addEventListener("click", ()=>closeModal(settingsBackdrop));
  settingsBackdrop.addEventListener("click", (e)=>{ if(e.target === settingsBackdrop) closeModal(settingsBackdrop); });

  // ===== Log helpers =====
  function getLog(raw){
    if(!raw) return { value:"", fail:false, easy:false };
    if("value" in raw) return { value: raw.value ?? "", fail: !!raw.fail, easy: !!raw.easy };
    if("weight" in raw) return { value: raw.weight ?? "", fail: !!raw.fail, easy: !!raw.easy };
    return { value:"", fail:false, easy:false };
  }

  function setLog(exKey, exType, value, fail, easy){
    if(!store.days[selectedDate]) store.days[selectedDate] = collectEditorData();
    store.days[selectedDate].workout = workoutSelect.value || "";
    store.days[selectedDate].workoutLog = store.days[selectedDate].workoutLog || {};
    store.days[selectedDate].workoutLog[exKey] = { type: exType, value: value ?? "", fail: !!fail, easy: !!easy };
    saveJSON(STORE_KEY, store);
    renderHistory();
  }

  function exposuresInWindow(exKey, daysBack){
    const out = [];
    for(let i=0;i<=daysBack;i++){
      const d = addDaysISO(selectedDate, -i);
      const raw = store.days[d]?.workoutLog?.[exKey];
      if(!raw) continue;
      const log = getLog(raw);
      if(log.value === "" || log.value === null || log.value === undefined) continue;
      out.push({ date:d, ...log });
    }
    return out; // most recent first
  }

  function hasHistoricalProgress(exKey){
    const dates = sortedDatesDesc().slice().reverse(); // oldest -> newest
    let min = null, max = null;
    for(const d of dates){
      const raw = store.days[d]?.workoutLog?.[exKey];
      if(!raw) continue;
      const v = Number(getLog(raw).value);
      if(!isFinite(v)) continue;
      if(min === null || v < min) min = v;
      if(max === null || v > max) max = v;
    }
    return (min !== null && max !== null && max > min);
  }

  // ===== Stall + upgrade detection =====
  function detectStallWeighted(exKey){
    // Conservative: 5 exposures in last 30 days, no load increase, >=2 failures, and has progressed before
    const logs = exposuresInWindow(exKey, 30);
    if(logs.length < 5) return { stalled:false };
    const weights = logs.slice(0,5).map(x=>Number(x.value)).filter(x=>isFinite(x));
    if(weights.length < 5) return { stalled:false };
    const max = Math.max(...weights);
    const min = Math.min(...weights);
    const fails = logs.slice(0,5).filter(x=>x.fail).length;
    if(max === min && fails >= 2 && hasHistoricalProgress(exKey)){
      return { stalled:true, detail:`5 logs/30d, stuck at ${max} with ${fails} failures` };
    }
    return { stalled:false };
  }

  function detectUpgradeTime(exKey, thresholdSec){
    const logs = exposuresInWindow(exKey, 60);
    if(logs.length < 3) return { upgrade:false };
    const top3 = logs.slice(0,3).map(x=>Number(x.value)).filter(x=>isFinite(x));
    if(top3.length < 3) return { upgrade:false };
    if(top3.every(v=>v >= thresholdSec)){
      return { upgrade:true, detail:`3 hits ≥ ${thresholdSec}s` };
    }
    return { upgrade:false };
  }

  function detectUpgradeReps(exKey, thresholdReps){
    const logs = exposuresInWindow(exKey, 60);
    if(logs.length < 3) return { upgrade:false };
    const top3 = logs.slice(0,3).map(x=>Number(x.value)).filter(x=>isFinite(x));
    if(top3.length < 3) return { upgrade:false };
    if(top3.every(v=>v >= thresholdReps)){
      return { upgrade:true, detail:`3 hits ≥ ${thresholdReps} reps` };
    }
    return { upgrade:false };
  }

  // ===== Recommendation logic =====
  function roundTo(x, inc){
    const step = Number(inc)||5;
    return Math.round(x/step)*step;
  }
  function lastValue(exKey){
    const logs = exposuresInWindow(exKey, 180);
    return logs.length ? logs[0] : null;
  }
  function recommend(exKey, type, poolName){
    const last = lastValue(exKey);
    if(!last) return "";

    // core types
    if(type === "time"){
      const v = Number(last.value);
      if(!isFinite(v)) return "";
      // If last 2 were same and >= threshold, keep same; otherwise small bump after 2 clean repeats
      const streak = exposuresInWindow(exKey, 90).slice(0,3).filter(x=>String(x.value)===String(v)).length;
      if(streak >= 2) return String(v + 10);
      return String(v);
    }
    if(type === "reps"){
      const v = Number(last.value);
      if(!isFinite(v)) return "";
      const streak = exposuresInWindow(exKey, 90).slice(0,3).filter(x=>String(x.value)===String(v)).length;
      if(streak >= 2) return String(v + 1);
      return String(v);
    }

    // weighted
    const lastW = Number(last.value);
    if(!isFinite(lastW)) return "";
    // microload per pool if enabled
    const inc = (settings.microload?.[poolName]) ? 2.5 : Number(settings.increment||5)||5;
    if(last.easy) return String(roundTo(lastW + inc, inc));
    if(last.fail) return String(lastW);
    // bump after 2 clean repeats
    const streak = exposuresInWindow(exKey, 90).slice(0,3).filter(x=>String(x.value)===String(lastW) && !x.fail && !x.easy).length;
    if(streak >= 2) return String(roundTo(lastW + inc, inc));
    return String(lastW);
  }

  function formatPrev(type, val){
    if(val === null || val === undefined || val === "") return "—";
    if(type === "time") return `${val} sec`;
    if(type === "reps") return `${val} reps`;
    return `${val} lb`;
  }
  function labelForType(type){
    if(type === "time") return "Time (sec)";
    if(type === "reps") return "Reps";
    return "Weight (lb)";
  }

  // ===== Swap / upgrade approval =====
  function approveRotation(poolName){
    const idx = settings.activeVariantIndex?.[poolName] ?? 0;
    const next = Math.min(idx + 1, POOLS[poolName].length - 1);
    settings.activeVariantIndex[poolName] = next;
    // once you rotate, clear microload flag (fresh stimulus)
    settings.microload[poolName] = false;
    saveJSON(SETTINGS_KEY, settings);
    // refresh plan if open
    openPlanModal(true);
  }

  function approveMicroload(poolName){
    settings.microload[poolName] = true;
    saveJSON(SETTINGS_KEY, settings);
    openPlanModal(true);
  }

  // ===== Plan Modal =====
  function activeVariant(poolName){
    const idx = settings.activeVariantIndex?.[poolName] ?? 0;
    return POOLS[poolName][Math.max(0, Math.min(idx, POOLS[poolName].length-1))];
  }

  function openPlanModal(isRefresh=false){
    const which = workoutSelect.value;
    if(which !== "A" && which !== "B") return;

    planTitle.textContent = `Workout ${which} — Track Plan`;
    planMeta.textContent = `${prettyDate(selectedDate)} • Default increment: ${settings.increment} lb`;
    if(!isRefresh) planRows.innerHTML = "";
    else planRows.innerHTML = "";

    const plan = TEMPLATE[which];

    plan.forEach((slot)=>{
      const variant = activeVariant(slot.pool);
      const exKey = variant.key;
      const exType = variant.type;

      const last = lastValue(exKey);
      const prevText = formatPrev(exType, last?.value ?? "");
      const goalVal = recommend(exKey, exType, slot.pool);
      const goalText = formatPrev(exType, goalVal);

      const rawToday = store.days[selectedDate]?.workoutLog?.[exKey];
      const todayLog = getLog(rawToday);
      const todayExisting = todayLog.value ?? "";
      const todayVal = (todayExisting === "" || todayExisting === null || todayExisting === undefined) ? (goalVal || "") : todayExisting;

      const reps = settings.reps?.[exKey] ?? slot.repsDefault;
      const repLine = (exType === "time") ? "near-failure (time)" : `${reps} reps${slot.perSide ? " each side" : ""}`;

      // flags
      let flag = null;
      if(exType === "weight"){
        const stall = detectStallWeighted(exKey);
        if(stall.stalled){
          flag = { kind:"stall", text:`Stall suspected`, detail: stall.detail };
        }
      } else if(exType === "time"){
        const up = detectUpgradeTime(exKey, settings.plankUpgradeSec || 90);
        if(up.upgrade && slot.pool === "plank" && (settings.activeVariantIndex.plank < POOLS.plank.length-1)){
          flag = { kind:"upgrade", text:`Upgrade suggested`, detail: up.detail };
        }
      } else if(exType === "reps"){
        const up = detectUpgradeReps(exKey, settings.legRaiseUpgradeReps || 18);
        if(up.upgrade && slot.pool === "legraise" && (settings.activeVariantIndex.legraise < POOLS.legraise.length-1)){
          flag = { kind:"upgrade", text:`Upgrade suggested`, detail: up.detail };
        }
      }

      const showFlags = (exType === "weight");

      const card = document.createElement("div");
      card.className = "planCard";

      card.innerHTML = `
        <div class="planName">${variant.name}</div>
        <div class="planSub">${slot.sets} sets × ${repLine} • ${variant.guide}</div>

        <div class="planMetaLines">
          <div><strong>Previous:</strong> ${prevText}</div>
          <div><strong>Today’s Goal:</strong> ${goalText}${settings.microload?.[slot.pool] && exType==="weight" ? " <span class='badge good'>microload</span>" : ""}</div>
        </div>

        <div class="planInputRow">
          <label class="small muted">${labelForType(exType)}</label>
          <input class="valInput" type="number" step="${exType==='weight' ? '0.5' : '1'}" inputmode="decimal" value="${String(todayVal).replaceAll('"','&quot;')}" />
        </div>

        ${showFlags ? `
          <div class="miniChecks">
            <label><input type="checkbox" class="failChk"> Hit failure</label>
            <label><input type="checkbox" class="easyChk"> Too easy</label>
          </div>
        ` : ``}

        <div class="flagRow" style="${flag ? "" : "display:none"}">
          <div class="left">
            <span class="badge warn">${flag ? (flag.kind==="stall" ? "⚠︎ Stall" : "↑ Upgrade") : ""}</span>
            <span class="small muted">${flag ? flag.detail : ""}</span>
          </div>
          <div class="right">
            ${flag && flag.kind==="stall" ? `
              <button type="button" class="microBtn">Use +2.5 microload</button>
              <button type="button" class="swapBtn">Approve swap</button>
            ` : ""}
            ${flag && flag.kind==="upgrade" ? `
              <button type="button" class="swapBtn">Approve upgrade</button>
            ` : ""}
          </div>
        </div>
      `;

      const valInput = card.querySelector(".valInput");

      if(showFlags){
        const failChk = card.querySelector(".failChk");
        const easyChk = card.querySelector(".easyChk");
        failChk.checked = !!todayLog.fail;
        easyChk.checked = !!todayLog.easy;

        failChk.addEventListener("change", ()=>{
          if(failChk.checked) easyChk.checked = false;
          setLog(exKey, exType, valInput.value, failChk.checked, easyChk.checked);
          queueAutoSave();
        });
        easyChk.addEventListener("change", ()=>{
          if(easyChk.checked) failChk.checked = false;
          setLog(exKey, exType, valInput.value, failChk.checked, easyChk.checked);
          queueAutoSave();
        });
        valInput.addEventListener("input", ()=>{
          setLog(exKey, exType, valInput.value, failChk.checked, easyChk.checked);
          queueAutoSave();
        });
        // persist autofill immediately
        setLog(exKey, exType, valInput.value, failChk.checked, easyChk.checked);
      } else {
        valInput.addEventListener("input", ()=>{
          setLog(exKey, exType, valInput.value, false, false);
          queueAutoSave();
        });
        setLog(exKey, exType, valInput.value, false, false);
      }

      // wire approvals
      const swapBtn = card.querySelector(".swapBtn");
      const microBtn = card.querySelector(".microBtn");
      if(microBtn){
        microBtn.addEventListener("click", ()=> approveMicroload(slot.pool));
      }
      if(swapBtn){
        swapBtn.addEventListener("click", ()=> approveRotation(slot.pool));
      }

      planRows.appendChild(card);
    });

    openModal(planBackdrop);
    queueAutoSave();
  }
  openPlanBtn.addEventListener("click", ()=>openPlanModal(false));

  // ===== Settings modal =====
  function openSettings(){
    setStepsGoal.value = settings.goals.steps;
    setCalsGoal.value = settings.goals.calories;
    setProteinGoal.value = settings.goals.protein;
    setIncrement.value = settings.increment;

    repSettings.innerHTML = "";
    // show reps for active variants only (keeps settings small)
    const activeVariantKeys = new Set();
    ["A","B"].forEach(w=>{
      TEMPLATE[w].forEach(slot=>{
        activeVariantKeys.add(activeVariant(slot.pool).key);
      });
    });
    Array.from(activeVariantKeys).forEach(k=>{
      // find readable name
      let display = k;
      for(const pool of Object.keys(POOLS)){
        const found = POOLS[pool].find(v=>v.key===k);
        if(found){ display = found.name; break; }
      }
      const wrap = document.createElement("div");
      wrap.className = "checkRow";
      wrap.style.marginBottom = "10px";
      wrap.innerHTML = `
        <div>
          <strong>${display}</strong>
          <div class="small">Reps target used for “sets × reps”</div>
        </div>
        <div class="right" style="gap:12px">
          <div style="width:120px">
            <label class="small muted">Reps</label>
            <input type="number" inputmode="numeric" min="1" step="1"
              value="${String(settings.reps?.[k] ?? 10)}"
              data-repkey="${k}">
          </div>
        </div>
      `;
      repSettings.appendChild(wrap);
    });

    const syncSettings = ()=>{
      settings.goals.steps = Number(setStepsGoal.value || DEFAULT_SETTINGS.goals.steps);
      settings.goals.calories = Number(setCalsGoal.value || DEFAULT_SETTINGS.goals.calories);
      settings.goals.protein = Number(setProteinGoal.value || DEFAULT_SETTINGS.goals.protein);
      settings.increment = Number(setIncrement.value || DEFAULT_SETTINGS.increment);

      saveJSON(SETTINGS_KEY, settings);
      refreshGoalTexts();
      syncChecksFromInputs();
      queueAutoSave();
    };
    [setStepsGoal,setCalsGoal,setProteinGoal,setIncrement].forEach(inp => inp.oninput = syncSettings);

    repSettings.querySelectorAll("input[data-repkey]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const k = inp.getAttribute("data-repkey");
        settings.reps[k] = Number(inp.value || 1);
        saveJSON(SETTINGS_KEY, settings);
        openPlanModal(true);
      });
    });

    openModal(settingsBackdrop);
  }
  settingsBtn.addEventListener("click", openSettings);

  resetSettingsBtn.addEventListener("click", ()=>{
    settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
    saveJSON(SETTINGS_KEY, settings);
    refreshGoalTexts();
    closeModal(settingsBackdrop);
    queueAutoSave();
  });

  // ===== Day data =====
  function collectEditorData(){
    syncChecksFromInputs();
    return {
      bodyWeight: bw.value || "",
      workout: workoutSelect.value || "",
      goals: {
        steps: steps.value || "",
        stepsMet: !!stepsChk.checked,
        calories: cals.value || "",
        caloriesMet: !!calsChk.checked,
        protein: protein.value || "",
        proteinMet: !!proteinChk.checked,
        activityDone: !!activityChk.checked
      },
      checkin: { stress: stressVal, energy: energyVal },
      workoutLog: store.days[selectedDate]?.workoutLog || {},
      updatedAt: new Date().toISOString()
    };
  }

  function loadDayIntoEditor(date){
    const day = store.days[date] || null;

    bw.value = "";
    workoutSelect.value = "";
    workoutDesc.textContent = workoutDescription("");
    updateOpenPlanVisibility();

    steps.value = "";
    cals.value = "";
    protein.value = "";
    stepsChk.checked = false;
    calsChk.checked = false;
    proteinChk.checked = false;
    activityChk.checked = false;

    stressVal = null;
    energyVal = null;
    setScaleValue(stressRow, stressHint, null);
    setScaleValue(energyRow, energyHint, null);

    if(!day) return;

    bw.value = day.bodyWeight ?? "";
    workoutSelect.value = day.workout ?? "";
    workoutDesc.textContent = workoutDescription(workoutSelect.value);
    updateOpenPlanVisibility();

    steps.value = day.goals?.steps ?? "";
    cals.value = day.goals?.calories ?? "";
    protein.value = day.goals?.protein ?? "";

    activityChk.checked = !!day.goals?.activityDone;

    stepsChk.checked = !!day.goals?.stepsMet;
    calsChk.checked = !!day.goals?.caloriesMet;
    proteinChk.checked = !!day.goals?.proteinMet;

    syncChecksFromInputs();

    stressVal = (day.checkin?.stress ?? null);
    energyVal = (day.checkin?.energy ?? null);
    setScaleValue(stressRow, stressHint, stressVal);
    setScaleValue(energyRow, energyHint, energyVal);
  }

  // nav + midnight
  function setSelectedDate(iso){
    selectedDate = iso;
    dateLabel.textContent = prettyDate(selectedDate);
    loadDayIntoEditor(selectedDate);
    renderWeightAverage();
  }
  prevDayBtn.addEventListener("click", ()=> setSelectedDate(addDaysISO(selectedDate, -1)));
  nextDayBtn.addEventListener("click", ()=> setSelectedDate(addDaysISO(selectedDate, +1)));
  todayBtn.addEventListener("click", ()=> setSelectedDate(todayISO()));

  let lastSeenToday = todayISO();
  setInterval(()=>{
    const t = todayISO();
    if(t !== lastSeenToday){
      if(selectedDate === lastSeenToday) setSelectedDate(t);
      lastSeenToday = t;
    }
  }, 25000);

  workoutSelect.addEventListener("change", ()=>{
    workoutDesc.textContent = workoutDescription(workoutSelect.value);
    updateOpenPlanVisibility();
    queueAutoSave();
  });

  // reset day no confirm
  resetBtn.addEventListener("click", ()=>{
    delete store.days[selectedDate];
    saveJSON(STORE_KEY, store);
    loadDayIntoEditor(selectedDate);
    renderHistory();
    renderWeightAverage();
  });

  // weight average (7 weigh-ins within 10 days ending on viewed day)
  function renderWeightAverage(){
    const weights = [];
    for(let i=0;i<10;i++){
      const d = addDaysISO(selectedDate, -i);
      const w = store.days[d]?.bodyWeight;
      const n = Number(w);
      if(isFinite(n) && n > 0) weights.push({ date: d, w: n });
    }
    if(weights.length >= 7){
      const use = weights.slice(0,7);
      const avg = use.reduce((s,x)=>s+x.w,0)/use.length;
      avgTitle.textContent = `7‑weigh‑in average: ${avg.toFixed(1)} lb`;
      avgBox.style.display = "block";
    } else {
      avgBox.style.display = "none";
    }
  }

  // history
  function renderHistory(){
    const dates = sortedDatesDesc();
    historyList.innerHTML = "";
    if(dates.length === 0){
      historyList.innerHTML = `<div class="small muted">No saved days yet. Start logging.</div>`;
      return;
    }
    dates.slice(0, 160).forEach(date=>{
      const day = store.days[date];
      const w = day.workout ? `Workout ${day.workout}` : "No workout";
      const bwTxt = day.bodyWeight ? `${day.bodyWeight} lb` : "No weigh-in";
      const badges = [];
      if(day.goals?.stepsMet) badges.push("Steps");
      if(day.goals?.caloriesMet) badges.push("Cals");
      if(day.goals?.proteinMet) badges.push("Protein");
      if(day.goals?.activityDone) badges.push("Activity");
      const st = day.checkin?.stress ?? "—";
      const en = day.checkin?.energy ?? "—";

      const item = document.createElement("div");
      item.className = "histItem";
      item.innerHTML = `
        <div class="left">
          <div class="date">${prettyDate(date)}</div>
          <div class="meta">${bwTxt} • ${w}</div>
          <div class="meta">Stress ${st} / Energy ${en}</div>
        </div>
        <div class="right">
          ${badges.map(b=>`<span class="badge good">${b}</span>`).join("")}
          <span class="badge">${w}</span>
          <button type="button" data-load="${date}">Load</button>
        </div>
      `;
      historyList.appendChild(item);
    });
    historyList.querySelectorAll("button[data-load]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const date = btn.getAttribute("data-load");
        setSelectedDate(date);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });
  }

  copyBtn.addEventListener("click", async ()=>{
    const payload = { date: selectedDate, data: store.days[selectedDate] || collectEditorData(), settings };
    const text = JSON.stringify(payload, null, 2);
    try{ await navigator.clipboard.writeText(text); alert("Copied backup JSON."); }
    catch(e){ prompt("Copy this JSON:", text); }
  });

  // INIT
  refreshGoalTexts();
  setSelectedDate(selectedDate);
  workoutDesc.textContent = workoutDescription(workoutSelect.value);
  updateOpenPlanVisibility();
  renderHistory();
  renderWeightAverage();
  syncChecksFromInputs();
})();
</script>
</body>
</html>
