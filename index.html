<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ben’s Lift + Daily Goals Tracker</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 25px rgba(17,24,39,.08);
      --radius:16px;
      --accent:#111827;
      --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:22px auto 80px;padding:0 16px;}
    header{display:flex;gap:12px;align-items:flex-end;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap}
    h1{margin:0;font-size:20px;letter-spacing:.2px;}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px;}
    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;}
    @media (max-width:860px){.row{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 10px;font-size:15px;}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
    input[type="number"], input[type="text"], select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      background:#fff;
      color:var(--text);
    }
    input:focus, select:focus{border-color:#cbd5e1}
    .inline{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:520px){.inline{grid-template-columns:1fr}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    button{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
    button.danger{border-color:#fecaca;color:var(--danger);}
    button.icon{padding:10px 11px; font-weight:900}
    button:disabled{opacity:.45; cursor:not-allowed}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);background:#fff;
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:520px){.twoCol{grid-template-columns:1fr}}
    .checkRow{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;border:1px solid var(--line);border-radius:14px;
    }
    .checkRow strong{font-size:13px}
    .checkRow .right{display:flex;gap:10px;align-items:center}
    .small{font-size:12px;color:var(--muted)}

    /* Switch */
    .switchLabel{display:inline-flex;align-items:center;cursor:pointer;user-select:none}
    .switchLabel input{position:absolute;opacity:0;pointer-events:none}
    .slider{
      width:46px;height:28px;border-radius:999px;
      background:#e5e7eb;border:1px solid var(--line);
      position:relative;flex:0 0 auto;
      transition: background .15s ease, border-color .15s ease;
    }
    .slider::after{
      content:"";position:absolute;top:3px;left:3px;
      width:22px;height:22px;border-radius:50%;
      background:#fff;border:1px solid var(--line);
      transition:left .15s ease, border-color .15s ease;
    }
    .switchLabel input:checked + .slider{background:#dcfce7;border-color:#86efac;}
    .switchLabel input:checked + .slider::after{left:21px;border-color:#86efac;}

    /* 1-10 picker */
    .scaleRow{display:flex;gap:6px;flex-wrap:wrap}
    .scaleBtn{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--line);background:#fff;
      font-weight:900;cursor:pointer;
    }
    .scaleBtn.on{background:#111827;color:#fff;border-color:#111827}
    .scaleHint{margin-top:6px}

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(17,24,39,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:min(980px, 100%);
      max-height: 86vh;
      overflow:auto;
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modalHeader{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .modalHeader h3{margin:0;font-size:15px}
    .modalHeader .meta{margin-top:4px;color:var(--muted);font-size:12px}

    .historyList{display:flex;flex-direction:column;gap:10px;max-height:560px;overflow:auto;padding-right:6px;}
    .histItem{
      border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;
      display:flex;gap:10px;justify-content:space-between;align-items:flex-start;
    }
    .histItem .left{min-width:0}
    .histItem .date{font-weight:950;font-size:13px}
    .histItem .meta{margin-top:4px;color:var(--muted);font-size:12px}
    .histItem .right{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .badge{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;color:#374151;white-space:nowrap;}
    .badge.good{border-color:#86efac;background:#dcfce7}

    .nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .dateLabel{font-weight:950;color:#111827}

    /* Plan cards */
    .planCard{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      margin:12px 0;
      background:#fff;
    }
    .planTop{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;
    }
    .planName{font-weight:950;font-size:14px}
    .planSub{margin-top:4px;color:var(--muted);font-size:12px}
    .planMetaLines{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}
    .planInputRow{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }
    .miniChecks{display:flex;gap:14px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .miniChecks label{margin:0;color:var(--muted);font-size:12px;display:flex;gap:8px;align-items:center}
    .miniChecks input{width:auto}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Lift + Daily Goals Tracker</h1>
        <div class="sub">Auto-saves every change. Uses your phone’s local time (EST/EDT). No accounts.</div>
      </div>

      <div class="nav">
        <button id="prevDayBtn" type="button">← Prev</button>
        <span class="pill"><span class="dateLabel" id="dateLabel">—</span></span>
        <button id="nextDayBtn" type="button">Next →</button>
        <button id="todayBtn" type="button">Today</button>
        <button id="settingsBtn" class="icon" type="button" title="Settings">⚙︎</button>
      </div>
    </header>

    <div class="row">
      <div class="card">
        <h2>Daily</h2>

        <div class="inline">
          <div>
            <label>Body weight (lb)</label>
            <input id="bw" type="number" step="0.1" placeholder="e.g. 159.0" />
          </div>
          <div>
            <label>Workout</label>
            <select id="workoutSelect">
              <option value="">None</option>
              <option value="A">Workout A</option>
              <option value="B">Workout B</option>
            </select>
          </div>
        </div>

        <div class="small muted" id="workoutDesc" style="margin-top:8px">Pick a workout to see what it is.</div>
        <div class="btns" style="margin-top:10px">
          <button id="openPlanBtn" class="primary" type="button" disabled style="display:none">Open & Track Plan</button>
        </div>

        <div class="hr"></div>

        <h2>Daily goals</h2>

        <div class="twoCol">
          <div class="checkRow">
            <div>
              <strong>Steps</strong>
              <div class="small" id="stepsGoalText">Goal: —</div>
            </div>
            <div class="right">
              <input id="steps" type="number" inputmode="numeric" style="width:140px" placeholder="0" />
              <label class="switchLabel" title="Met steps goal">
                <input id="stepsChk" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="checkRow">
            <div>
              <strong>Calories</strong>
              <div class="small" id="calsGoalText">Limit: —</div>
            </div>
            <div class="right">
              <input id="cals" type="number" inputmode="numeric" style="width:140px" placeholder="0" />
              <label class="switchLabel" title="Under calorie limit">
                <input id="calsChk" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="checkRow">
            <div>
              <strong>Protein</strong>
              <div class="small" id="proteinGoalText">Goal: —</div>
            </div>
            <div class="right">
              <input id="protein" type="number" inputmode="numeric" style="width:140px" placeholder="0" />
              <label class="switchLabel" title="Hit protein goal">
                <input id="proteinChk" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="checkRow">
            <div>
              <strong>Pickleball / Activity</strong>
              <div class="small">Did any intentional activity?</div>
            </div>
            <div class="right">
              <label class="switchLabel" title="Did pickleball or another activity">
                <input id="activityChk" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Check-in</h2>
        <div class="twoCol">
          <div>
            <label>Stress (1–10)</label>
            <div class="scaleRow" id="stressRow"></div>
            <div class="small muted scaleHint" id="stressHint">Not set</div>
          </div>
          <div>
            <label>Energy (1–10)</label>
            <div class="scaleRow" id="energyRow"></div>
            <div class="small muted scaleHint" id="energyHint">Not set</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="btns">
          <button id="copyBtn" type="button">Copy backup</button>
          <button id="deleteBtn" class="danger" type="button">Delete day</button>
        </div>
      </div>

      <div class="card">
        <h2>History (latest first)</h2>
        <div class="small muted" style="margin-bottom:10px">Tap “Load” to bring a day back.</div>
        <div class="historyList" id="historyList"></div>
      </div>
    </div>
  </div>

  <!-- Plan Modal -->
  <div class="modalBackdrop" id="planBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div>
          <h3 id="planTitle">Workout Plan</h3>
          <div class="meta" id="planMeta">—</div>
        </div>
        <div class="btns" style="margin-top:0">
          <button id="closePlanBtn" type="button">Close</button>
        </div>
      </div>

      <div class="small muted" style="margin-bottom:8px">
        Fields auto-fill with Today’s Goal; change them if needed.
      </div>

      <div id="planRows"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modalBackdrop" id="settingsBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div>
          <h3>Settings</h3>
          <div class="meta">Goals + rep targets. Saved automatically.</div>
        </div>
        <div class="btns" style="margin-top:0">
          <button id="closeSettingsBtn" type="button">Close</button>
        </div>
      </div>

      <div class="twoCol">
        <div>
          <label>Steps goal</label>
          <input id="setStepsGoal" type="number" inputmode="numeric" />
        </div>
        <div>
          <label>Calorie limit</label>
          <input id="setCalsGoal" type="number" inputmode="numeric" />
        </div>
      </div>

      <div class="twoCol" style="margin-top:12px">
        <div>
          <label>Protein goal (g)</label>
          <input id="setProteinGoal" type="number" inputmode="numeric" />
        </div>
        <div>
          <label>Weight increment (lb)</label>
          <input id="setIncrement" type="number" step="0.5" inputmode="decimal" />
          <div class="small muted" style="margin-top:6px">Used for “Today’s Goal” bumps (default 5).</div>
        </div>
      </div>

      <div class="hr"></div>
      <h2 style="margin:0 0 10px;font-size:15px;">Rep targets</h2>
      <div class="small muted" style="margin-bottom:10px">Plan assumes these reps (change anytime).</div>
      <div id="repSettings"></div>

      <div class="hr"></div>
      <button id="resetSettingsBtn" class="danger" type="button">Reset settings to defaults</button>
    </div>
  </div>

<script>
(() => {
  const PROGRAM = {
    A: [
      { key:"bench", name:"Barbell Bench Press", sets:3, repsDefault:9, guide:"3 sets, steady reps", type:"weight" },
      { key:"db_row", name:"One-arm Dumbbell Row", sets:3, repsDefault:10, guide:"Each side", type:"weight" },
      { key:"db_press", name:"Dumbbell Shoulder Press", sets:3, repsDefault:9, guide:"Control down", type:"weight" },
      { key:"curl", name:"Barbell or DB Bicep Curl", sets:3, repsDefault:11, guide:"No swinging", type:"weight" },
      { key:"plank", name:"Plank", sets:3, repsDefault:1, guide:"Time to near-failure", type:"time" }
    ],
    B: [
      { key:"squat", name:"Barbell Squat", sets:3, repsDefault:9, guide:"Brace hard", type:"weight" },
      { key:"rdl", name:"Romanian Deadlift", sets:3, repsDefault:9, guide:"Hamstrings", type:"weight" },
      { key:"pushup", name:"Pushups (slow + controlled)", sets:3, repsDefault:12, guide:"Full range", type:"weight" },
      { key:"hammer", name:"Hammer Curls", sets:3, repsDefault:11, guide:"Neutral grip", type:"weight" },
      { key:"leg_raise", name:"Leg Raises (lying)", sets:3, repsDefault:13, guide:"Controlled reps", type:"reps" }
    ]
  };

  function buildDefaultReps(){
    const reps = {};
    ["A","B"].forEach(w => PROGRAM[w].forEach(ex => reps[ex.key] = ex.repsDefault));
    return reps;
  }

  const DEFAULT_SETTINGS = {
    goals: { steps: 10000, calories: 1800, protein: 130 },
    increment: 5,
    reps: buildDefaultReps(),
    timeIncrementSec: 10,
    repsIncrement: 1
  };

  const STORE_KEY = "ben_lift_daily_tracker_v5_store";
  const SETTINGS_KEY = "ben_lift_daily_tracker_v5_settings";

  const el = (id)=>document.getElementById(id);

  function loadJSON(key, fallback){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
    catch(e){ return fallback; }
  }
  function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  let store = loadJSON(STORE_KEY, { days: {} });
  let settings = loadJSON(SETTINGS_KEY, DEFAULT_SETTINGS);

  if(!settings || typeof settings !== "object") settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
  if(!settings.goals) settings.goals = JSON.parse(JSON.stringify(DEFAULT_SETTINGS.goals));
  if(!settings.reps) settings.reps = buildDefaultReps();
  if(!settings.increment) settings.increment = DEFAULT_SETTINGS.increment;
  if(!settings.timeIncrementSec) settings.timeIncrementSec = DEFAULT_SETTINGS.timeIncrementSec;
  if(!settings.repsIncrement) settings.repsIncrement = DEFAULT_SETTINGS.repsIncrement;

  function isoLocalDate(d){
    const tzOffset = d.getTimezoneOffset();
    const local = new Date(d.getTime() - tzOffset*60000);
    return local.toISOString().slice(0,10);
  }
  function todayISO(){ return isoLocalDate(new Date()); }
  function addDaysISO(iso, delta){
    const [y,m,dd] = iso.split("-").map(Number);
    const d = new Date(y, m-1, dd);
    d.setDate(d.getDate() + delta);
    return isoLocalDate(d);
  }
  function prettyDate(iso){
    const [y,m,d] = iso.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"short", day:"numeric" });
  }
  function sortedDatesDesc(){
    return Object.keys(store.days).sort((a,b)=> b.localeCompare(a));
  }

  const dateLabel = el("dateLabel");
  const prevDayBtn = el("prevDayBtn");
  const nextDayBtn = el("nextDayBtn");
  const todayBtn = el("todayBtn");
  const settingsBtn = el("settingsBtn");

  const bw = el("bw");
  const workoutSelect = el("workoutSelect");
  const workoutDesc = el("workoutDesc");
  const openPlanBtn = el("openPlanBtn");

  const stepsGoalText = el("stepsGoalText");
  const calsGoalText = el("calsGoalText");
  const proteinGoalText = el("proteinGoalText");

  const steps = el("steps");
  const cals = el("cals");
  const protein = el("protein");
  const stepsChk = el("stepsChk");
  const calsChk = el("calsChk");
  const proteinChk = el("proteinChk");
  const activityChk = el("activityChk");

  const stressRow = el("stressRow");
  const energyRow = el("energyRow");
  const stressHint = el("stressHint");
  const energyHint = el("energyHint");

  const copyBtn = el("copyBtn");
  const deleteBtn = el("deleteBtn");
  const historyList = el("historyList");

  const planBackdrop = el("planBackdrop");
  const planTitle = el("planTitle");
  const planMeta = el("planMeta");
  const planRows = el("planRows");
  const closePlanBtn = el("closePlanBtn");

  const settingsBackdrop = el("settingsBackdrop");
  const closeSettingsBtn = el("closeSettingsBtn");
  const setStepsGoal = el("setStepsGoal");
  const setCalsGoal = el("setCalsGoal");
  const setProteinGoal = el("setProteinGoal");
  const setIncrement = el("setIncrement");
  const repSettings = el("repSettings");
  const resetSettingsBtn = el("resetSettingsBtn");

  let selectedDate = todayISO();
  let stressVal = null;
  let energyVal = null;

  let saveTimer = null;
  function queueAutoSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(autoSaveNow, 160);
  }
  function autoSaveNow(){
    store.days[selectedDate] = collectEditorData();
    saveJSON(STORE_KEY, store);
    renderHistory();
  }

  function refreshGoalTexts(){
    stepsGoalText.textContent = `Goal: ${settings.goals.steps.toLocaleString()}`;
    calsGoalText.textContent = `Limit: ${settings.goals.calories.toLocaleString()}`;
    proteinGoalText.textContent = `Goal: ${settings.goals.protein}g`;
  }

  function workoutDescription(which){
    if(which === "A") return "Workout A = chest/press + back row + shoulders + biceps + plank.";
    if(which === "B") return "Workout B = squat + hinge (RDL) + pushups + biceps + leg raises.";
    return "Pick a workout to see what it is.";
  }
  function updateOpenPlanVisibility(){
    const ok = (workoutSelect.value === "A" || workoutSelect.value === "B");
    openPlanBtn.style.display = ok ? "inline-block" : "none";
    openPlanBtn.disabled = !ok;
  }

  function syncChecksFromInputs(){
    const s = Number(steps.value || 0);
    stepsChk.checked = s >= settings.goals.steps;

    const cal = Number(cals.value || 0);
    calsChk.checked = cal > 0 ? cal <= settings.goals.calories : false;

    const p = Number(protein.value || 0);
    proteinChk.checked = p >= settings.goals.protein;
  }

  stepsChk.addEventListener("change", ()=>{
    if(stepsChk.checked) steps.value = String(settings.goals.steps);
    queueAutoSave();
  });
  calsChk.addEventListener("change", ()=>{
    if(calsChk.checked) cals.value = String(settings.goals.calories);
    queueAutoSave();
  });
  proteinChk.addEventListener("change", ()=>{
    if(proteinChk.checked) protein.value = String(settings.goals.protein);
    queueAutoSave();
  });
  activityChk.addEventListener("change", queueAutoSave);

  [steps,cals,protein,bw].forEach(inp=>{
    inp.addEventListener("input", ()=>{
      syncChecksFromInputs();
      queueAutoSave();
    });
  });

  function buildScale(rowEl, hintEl, setter){
    rowEl.innerHTML = "";
    for(let i=1;i<=10;i++){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "scaleBtn";
      b.textContent = String(i);
      b.dataset.val = String(i);
      b.addEventListener("click", ()=>{
        rowEl.querySelectorAll(".scaleBtn").forEach(x=>x.classList.remove("on"));
        b.classList.add("on");
        hintEl.textContent = `Selected: ${i}`;
        setter(i);
        queueAutoSave();
      });
      rowEl.appendChild(b);
    }
  }
  function setScaleValue(rowEl, hintEl, val){
    rowEl.querySelectorAll(".scaleBtn").forEach(x=>{
      x.classList.toggle("on", Number(x.dataset.val) === Number(val));
    });
    hintEl.textContent = val ? `Selected: ${val}` : "Not set";
  }
  buildScale(stressRow, stressHint, (v)=>{ stressVal = v; });
  buildScale(energyRow, energyHint, (v)=>{ energyVal = v; });

  function openModal(backdrop){ backdrop.classList.add("show"); backdrop.setAttribute("aria-hidden","false"); }
  function closeModal(backdrop){ backdrop.classList.remove("show"); backdrop.setAttribute("aria-hidden","true"); }

  closePlanBtn.addEventListener("click", ()=>closeModal(planBackdrop));
  planBackdrop.addEventListener("click", (e)=>{ if(e.target === planBackdrop) closeModal(planBackdrop); });

  closeSettingsBtn.addEventListener("click", ()=>closeModal(settingsBackdrop));
  settingsBackdrop.addEventListener("click", (e)=>{ if(e.target === settingsBackdrop) closeModal(settingsBackdrop); });

  function escapeAttr(v){ return (v===null||v===undefined) ? "" : String(v).replaceAll('"','&quot;'); }

  function getLogValue(raw){
    if(!raw) return { value:"", fail:false, easy:false };
    if("value" in raw) return { value: raw.value ?? "", fail: !!raw.fail, easy: !!raw.easy };
    if("weight" in raw) return { value: raw.weight ?? "", fail: !!raw.fail, easy: !!raw.easy };
    return { value:"", fail:false, easy:false };
  }

  function setLogValue(exKey, exType, value, fail, easy){
    if(!store.days[selectedDate]) store.days[selectedDate] = collectEditorData();
    store.days[selectedDate].workout = workoutSelect.value || "";
    store.days[selectedDate].workoutLog = store.days[selectedDate].workoutLog || {};
    store.days[selectedDate].workoutLog[exKey] = { type: exType, value: value ?? "", fail: !!fail, easy: !!easy };
    saveJSON(STORE_KEY, store);
    renderHistory();
  }

  function findLastForExercise(exKey){
    const dates = sortedDatesDesc();
    for(const dt of dates){
      if(dt === selectedDate) continue;
      const raw = store.days[dt]?.workoutLog?.[exKey];
      if(!raw) continue;
      const log = getLogValue(raw);
      if(log.value !== "" && log.value !== null && log.value !== undefined) return { date: dt, ...log };
    }
    return null;
  }

  function findConsecutiveSuccesses(exKey, valStr){
    if(!valStr) return 0;
    let count = 0;
    const dates = sortedDatesDesc();
    for(const dt of dates){
      if(dt === selectedDate) continue;
      const raw = store.days[dt]?.workoutLog?.[exKey];
      if(!raw) continue;
      const log = getLogValue(raw);
      if(String(log.value) === String(valStr)){
        if(log.fail || log.easy) break;
        count += 1;
      } else break;
    }
    return count;
  }

  function roundTo(x, inc){
    const step = Number(inc)||5;
    return Math.round(x/step)*step;
  }

  function recommendForExercise(ex){
    const last = findLastForExercise(ex.key);
    if(!last) return "";

    if(ex.type === "time"){
      const lastSec = Number(last.value);
      if(!isFinite(lastSec)) return "";
      if(last.fail) return String(lastSec);
      const streak = findConsecutiveSuccesses(ex.key, String(lastSec));
      if(streak >= 2) return String(lastSec + (Number(settings.timeIncrementSec)||10));
      return String(lastSec);
    }
    if(ex.type === "reps"){
      const lastReps = Number(last.value);
      if(!isFinite(lastReps)) return "";
      if(last.fail) return String(lastReps);
      const streak = findConsecutiveSuccesses(ex.key, String(lastReps));
      if(streak >= 2) return String(lastReps + (Number(settings.repsIncrement)||1));
      return String(lastReps);
    }

    const lastW = Number(last.value);
    if(!isFinite(lastW)) return "";
    const inc = Number(settings.increment||5)||5;
    if(last.easy) return String(roundTo(lastW+inc, inc));
    if(last.fail) return String(lastW);
    const streak = findConsecutiveSuccesses(ex.key, String(lastW));
    return (streak >= 2) ? String(roundTo(lastW+inc, inc)) : String(lastW);
  }

  function formatPrevious(ex){
    const last = findLastForExercise(ex.key);
    if(!last || last.value === "") return "—";
    if(ex.type === "time") return `${last.value} sec`;
    if(ex.type === "reps") return `${last.value} reps`;
    return `${last.value} lb`;
  }

  function formatGoal(ex, goalVal){
    if(!goalVal) return "—";
    if(ex.type === "time") return `${goalVal} sec`;
    if(ex.type === "reps") return `${goalVal} reps`;
    return `${goalVal} lb`;
  }

  function inputLabel(ex){
    if(ex.type === "time") return "Time (sec)";
    if(ex.type === "reps") return "Reps";
    return "Weight (lb)";
  }

  function openPlanModal(){
    const which = workoutSelect.value;
    if(which !== "A" && which !== "B") return;

    planTitle.textContent = `Workout ${which} — Track Plan`;
    planMeta.textContent = `${prettyDate(selectedDate)} • Increment: ${settings.increment} lb`;
    planRows.innerHTML = "";

    const plan = PROGRAM[which];
    plan.forEach(ex=>{
      const prevText = formatPrevious(ex);
      const goalVal = recommendForExercise(ex);
      const goalText = formatGoal(ex, goalVal);

      const rawToday = store.days[selectedDate]?.workoutLog?.[ex.key];
      const todayLog = getLogValue(rawToday);
      const todayValExisting = todayLog.value ?? "";
      const todayVal = (todayValExisting === "" || todayValExisting === null || todayValExisting === undefined)
        ? (goalVal || "")
        : todayValExisting;

      const showFlags = (ex.type === "weight");

      const reps = settings.reps?.[ex.key] ?? ex.repsDefault;
      const repLine = (ex.type === "time") ? "near-failure (time)" : `${reps} reps`;

      const card = document.createElement("div");
      card.className = "planCard";
      card.innerHTML = `
        <div class="planTop">
          <div>
            <div class="planName">${ex.name}</div>
            <div class="planSub">${ex.sets} sets × ${repLine} • ${ex.guide}</div>
          </div>
        </div>

        <div class="planMetaLines">
          <div><strong>Previous:</strong> ${prevText}</div>
          <div><strong>Today’s Goal:</strong> ${goalText}</div>
        </div>

        <div class="planInputRow">
          <div>
            <label class="small muted">${inputLabel(ex)}</label>
            <input class="valInput" type="number" step="${ex.type==='weight' ? '0.5' : '1'}" inputmode="decimal" value="${escapeAttr(todayVal)}" />
          </div>
        </div>

        ${showFlags ? `
          <div class="miniChecks">
            <label><input type="checkbox" class="failChk"> Hit failure</label>
            <label><input type="checkbox" class="easyChk"> Too easy</label>
          </div>
        ` : ``}
      `;

      const valInput = card.querySelector(".valInput");

      if(showFlags){
        const failChk = card.querySelector(".failChk");
        const easyChk = card.querySelector(".easyChk");
        failChk.checked = !!todayLog.fail;
        easyChk.checked = !!todayLog.easy;

        failChk.addEventListener("change", ()=>{
          if(failChk.checked) easyChk.checked = false;
          setLogValue(ex.key, ex.type, valInput.value, failChk.checked, easyChk.checked);
          queueAutoSave();
        });
        easyChk.addEventListener("change", ()=>{
          if(easyChk.checked) failChk.checked = false;
          setLogValue(ex.key, ex.type, valInput.value, failChk.checked, easyChk.checked);
          queueAutoSave();
        });
        valInput.addEventListener("input", ()=>{
          setLogValue(ex.key, ex.type, valInput.value, failChk.checked, easyChk.checked);
          queueAutoSave();
        });

        setLogValue(ex.key, ex.type, valInput.value, failChk.checked, easyChk.checked);
      } else {
        valInput.addEventListener("input", ()=>{
          setLogValue(ex.key, ex.type, valInput.value, false, false);
          queueAutoSave();
        });
        setLogValue(ex.key, ex.type, valInput.value, false, false);
      }

      planRows.appendChild(card);
    });

    openModal(planBackdrop);
    queueAutoSave();
  }

  openPlanBtn.addEventListener("click", openPlanModal);

  function openSettings(){
    setStepsGoal.value = settings.goals.steps;
    setCalsGoal.value = settings.goals.calories;
    setProteinGoal.value = settings.goals.protein;
    setIncrement.value = settings.increment;

    repSettings.innerHTML = "";
    const all = [...PROGRAM.A, ...PROGRAM.B];
    all.forEach(ex=>{
      const wrap = document.createElement("div");
      wrap.className = "checkRow";
      wrap.style.marginBottom = "10px";
      wrap.innerHTML = `
        <div>
          <strong>${ex.name}</strong>
          <div class="small">Default reps: ${ex.repsDefault}${ex.type==="time" ? " (time-based)" : ""}</div>
        </div>
        <div class="right" style="gap:12px">
          <div style="width:120px">
            <label class="small muted">Reps</label>
            <input type="number" inputmode="numeric" min="1" step="1"
              value="${escapeAttr(settings.reps?.[ex.key] ?? ex.repsDefault)}"
              data-repkey="${ex.key}">
          </div>
        </div>
      `;
      repSettings.appendChild(wrap);
    });

    const syncSettings = ()=>{
      settings.goals.steps = Number(setStepsGoal.value || DEFAULT_SETTINGS.goals.steps);
      settings.goals.calories = Number(setCalsGoal.value || DEFAULT_SETTINGS.goals.calories);
      settings.goals.protein = Number(setProteinGoal.value || DEFAULT_SETTINGS.goals.protein);
      settings.increment = Number(setIncrement.value || DEFAULT_SETTINGS.increment);

      saveJSON(SETTINGS_KEY, settings);
      refreshGoalTexts();
      syncChecksFromInputs();
      queueAutoSave();
    };
    [setStepsGoal,setCalsGoal,setProteinGoal,setIncrement].forEach(inp => inp.oninput = syncSettings);

    repSettings.querySelectorAll("input[data-repkey]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const k = inp.getAttribute("data-repkey");
        settings.reps[k] = Number(inp.value || 1);
        saveJSON(SETTINGS_KEY, settings);
        queueAutoSave();
      });
    });

    openModal(settingsBackdrop);
  }
  settingsBtn.addEventListener("click", openSettings);

  resetSettingsBtn.addEventListener("click", ()=>{
    if(confirm("Reset settings to defaults?")){
      settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
      saveJSON(SETTINGS_KEY, settings);
      refreshGoalTexts();
      closeModal(settingsBackdrop);
      queueAutoSave();
    }
  });

  function collectEditorData(){
    syncChecksFromInputs();
    return {
      bodyWeight: bw.value || "",
      workout: workoutSelect.value || "",
      goals: {
        steps: steps.value || "",
        stepsMet: !!stepsChk.checked,
        calories: cals.value || "",
        caloriesMet: !!calsChk.checked,
        protein: protein.value || "",
        proteinMet: !!proteinChk.checked,
        activityDone: !!activityChk.checked
      },
      checkin: { stress: stressVal, energy: energyVal },
      workoutLog: store.days[selectedDate]?.workoutLog || {},
      updatedAt: new Date().toISOString()
    };
  }

  function loadDayIntoEditor(date){
    const day = store.days[date] || null;

    bw.value = "";
    workoutSelect.value = "";
    workoutDesc.textContent = workoutDescription("");
    updateOpenPlanVisibility();

    steps.value = "";
    cals.value = "";
    protein.value = "";
    stepsChk.checked = false;
    calsChk.checked = false;
    proteinChk.checked = false;
    activityChk.checked = false;

    stressVal = null;
    energyVal = null;
    setScaleValue(stressRow, stressHint, null);
    setScaleValue(energyRow, energyHint, null);

    if(!day) return;

    bw.value = day.bodyWeight ?? "";
    workoutSelect.value = day.workout ?? "";
    workoutDesc.textContent = workoutDescription(workoutSelect.value);
    updateOpenPlanVisibility();

    steps.value = day.goals?.steps ?? "";
    cals.value = day.goals?.calories ?? "";
    protein.value = day.goals?.protein ?? "";

    activityChk.checked = !!day.goals?.activityDone;

    stepsChk.checked = !!day.goals?.stepsMet;
    calsChk.checked = !!day.goals?.caloriesMet;
    proteinChk.checked = !!day.goals?.proteinMet;
    syncChecksFromInputs();

    stressVal = (day.checkin?.stress ?? null);
    energyVal = (day.checkin?.energy ?? null);
    setScaleValue(stressRow, stressHint, stressVal);
    setScaleValue(energyRow, energyHint, energyVal);
  }

  function setSelectedDate(iso){
    selectedDate = iso;
    dateLabel.textContent = prettyDate(selectedDate);
    loadDayIntoEditor(selectedDate);
  }
  prevDayBtn.addEventListener("click", ()=> setSelectedDate(addDaysISO(selectedDate, -1)));
  nextDayBtn.addEventListener("click", ()=> setSelectedDate(addDaysISO(selectedDate, +1)));
  todayBtn.addEventListener("click", ()=> setSelectedDate(todayISO()));

  let lastSeenToday = todayISO();
  setInterval(()=>{
    const t = todayISO();
    if(t !== lastSeenToday){
      if(selectedDate === lastSeenToday) setSelectedDate(t);
      lastSeenToday = t;
    }
  }, 25000);

  workoutSelect.addEventListener("change", ()=>{
    workoutDesc.textContent = workoutDescription(workoutSelect.value);
    updateOpenPlanVisibility();
    queueAutoSave();
  });

  function renderHistory(){
    const dates = sortedDatesDesc();
    historyList.innerHTML = "";
    if(dates.length === 0){
      historyList.innerHTML = `<div class="small muted">No saved days yet. Start logging.</div>`;
      return;
    }
    dates.slice(0, 160).forEach(date=>{
      const day = store.days[date];
      const w = day.workout ? `Workout ${day.workout}` : "No workout";
      const bwTxt = day.bodyWeight ? `${day.bodyWeight} lb` : "No weigh-in";
      const badges = [];
      if(day.goals?.stepsMet) badges.push("Steps");
      if(day.goals?.caloriesMet) badges.push("Cals");
      if(day.goals?.proteinMet) badges.push("Protein");
      if(day.goals?.activityDone) badges.push("Activity");
      const st = day.checkin?.stress ?? "—";
      const en = day.checkin?.energy ?? "—";

      const item = document.createElement("div");
      item.className = "histItem";
      item.innerHTML = `
        <div class="left">
          <div class="date">${prettyDate(date)}</div>
          <div class="meta">${bwTxt} • ${w}</div>
          <div class="meta">Stress ${st} / Energy ${en}</div>
        </div>
        <div class="right">
          ${badges.map(b=>`<span class="badge good">${b}</span>`).join("")}
          <span class="badge">${w}</span>
          <button type="button" data-load="${date}">Load</button>
        </div>
      `;
      historyList.appendChild(item);
    });
    historyList.querySelectorAll("button[data-load]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const date = btn.getAttribute("data-load");
        setSelectedDate(date);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });
  }
//
  copyBtn.addEventListener("click", async ()=>{
    const payload = { date: selectedDate, data: store.days[selectedDate] || collectEditorData() };
    const text = JSON.stringify(payload, null, 2);
    try{ await navigator.clipboard.writeText(text); alert("Copied day as JSON to clipboard."); }
    catch(e){ prompt("Copy this JSON:", text); }
  });
  deleteBtn.addEventListener("click", ()=>{
    if(!store.days[selectedDate]){ alert("Nothing saved for this day."); return; }
    if(confirm(`Delete ${prettyDate(selectedDate)}? This can’t be undone.`)){
      delete store.days[selectedDate];
      saveJSON(STORE_KEY, store);
      loadDayIntoEditor(selectedDate);
      renderHistory();
    }
  });

  refreshGoalTexts();
  setSelectedDate(selectedDate);
  workoutDesc.textContent = workoutDescription(workoutSelect.value);
  updateOpenPlanVisibility();
  renderHistory();
  syncChecksFromInputs();
})();
</script>
</body>
</html>
